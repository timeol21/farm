// #include <iostream>      //?????????????????
// #include <fcntl.h>
// #include <unistd.h>
// #include <termios.h>
// #include <cstring>
// #include <chrono>
// #include <thread>
// #include <iomanip>

// using namespace std;

// int serialFd = -1;

// // ?????????9600???????8N1?????????????DC-A568-V06????4??
// bool configureSerial(int fd) {
//     struct termios tty;
//     if (tcgetattr(fd, &tty) != 0) {
//         perror("?????????????");
//         return false;
//     }

//     cfsetospeed(&tty, B9600);
//     cfsetispeed(&tty, B9600);

//     tty.c_cflag &= ~PARENB;
//     tty.c_cflag &= ~CSTOPB;
//     tty.c_cflag &= ~CSIZE;
//     tty.c_cflag |= CS8;
//     tty.c_cflag &= ~CRTSCTS;
//     tty.c_cflag |= CREAD | CLOCAL;

//     tty.c_iflag &= ~(IXON | IXOFF | IXANY);
//     tty.c_iflag &= ~(IGNBRK | BRKINT | PARMRK | ISTRIP | INLCR | IGNCR | ICRNL);
//     tty.c_oflag = 0;
//     tty.c_lflag = 0;

//     tty.c_cc[VMIN] = 0;
//     tty.c_cc[VTIME] = 10;

//     if (tcsetattr(fd, TCSANOW, &tty) != 0) {
//         perror("??????????????");
//         return false;
//     }
//     return true;
// }

// // ??????????????/dev/ttyS4??
// bool initSerial() {
//     const char *port = "/dev/ttyS4";
//     serialFd = open(port, O_RDWR | O_NOCTTY | O_SYNC);
//     if (serialFd < 0) {
//         perror("???????????????sudo???§µ?");
//         return false;
//     }
//     if (!configureSerial(serialFd)) {
//         close(serialFd);
//         serialFd = -1;
//         return false;
//     }
//     cout << "????" << port << "????????" << endl;
//     return true;
// }

// // ???????????????????????????????????????????????
// void readHumiture() {
//     if (serialFd < 0) return;

//     // ???????????0x01???????0x0000????2????????????+?????????????
//     unsigned char sendBuf[] = {0x01, 0x03, 0x00, 0x00, 0x00, 0x02, 0xC4, 0x0B};
//     write(serialFd, sendBuf, sizeof(sendBuf));
//     cout << "?????????01 03 00 00 00 02 C4 0B" << endl;

//     // ????????????
//     unsigned char recvBuf[256] = {0};
//     ssize_t len = read(serialFd, recvBuf, sizeof(recvBuf));

//     // ???????9????????MODBUS RTU§¿?ï‚
//     if (len == 9 && recvBuf[0] == 0x01 && recvBuf[1] == 0x03) {
//         // ????????1???????=??????2???????=????????????/10=??????
//         uint16_t humiData = (recvBuf[3] << 8) | recvBuf[4];  // ????0x01A8 ?? 424 ?? 42.4%RH
//         uint16_t tempData = (recvBuf[5] << 8) | recvBuf[6];  // ????0x00D9 ?? 217 ?? 21.7??

//         // ????????????????????????????????? tempData ?? 217?? ?????????????????
//         float temperature = tempData / 10.0;
//         float humidity = humiData / 10.0;

//         cout << "????????" << endl;
//         cout << "????" << fixed << setprecision(1) << temperature << "?? " 
//              << "????" << fixed << setprecision(1) << humidity << "%RH" << endl;
//     } else if (len == 0) {
//         cout << "¦Ä??????????????????????????" << endl;
//     } else {
//         cout << "????????????" << len << "??????";
//         for (ssize_t i = 0; i < len; ++i) printf("%02X ", recvBuf[i]);
//         cout << endl;
//     }
//     cout << "----------------------------------------" << endl;
// }

// // ??????
// void closeSerial() {
//     if (serialFd >= 0) {
//         close(serialFd);
//         cout << "????????" << endl;
//     }
// }

// int main() {
//     if (!initSerial()) return 1;

//     cout << "???????????????Ctrl+C????" << endl;
//     cout << "----------------------------------------" << endl;

//     while (true) {
//         readHumiture();
//         this_thread::sleep_for(chrono::seconds(1));  // 1???????
//     }

//     closeSerial();
//     return 0;
// }


#include <iostream>           //??????????????????????????????????????????
#include <fcntl.h>
#include <unistd.h>
#include <termios.h>
#include <cstring>
#include <chrono>
#include <thread>
#include <iomanip>

using namespace std;

int serialFd = -1;

// ?????????9600???????8N1?????????????DC-A568-V06????4??
bool configureSerial(int fd) {
    struct termios tty;
    if (tcgetattr(fd, &tty) != 0) {
        perror("?????????????");
        return false;
    }

    cfsetospeed(&tty, B9600);
    cfsetispeed(&tty, B9600);

    tty.c_cflag &= ~PARENB;
    tty.c_cflag &= ~CSTOPB;
    tty.c_cflag &= ~CSIZE;
    tty.c_cflag |= CS8;
    tty.c_cflag &= ~CRTSCTS;
    tty.c_cflag |= CREAD | CLOCAL;

    tty.c_iflag &= ~(IXON | IXOFF | IXANY);
    tty.c_iflag &= ~(IGNBRK | BRKINT | PARMRK | ISTRIP | INLCR | IGNCR | ICRNL);
    tty.c_oflag = 0;
    tty.c_lflag = 0;

    tty.c_cc[VMIN] = 0;
    tty.c_cc[VTIME] = 10;

    if (tcsetattr(fd, TCSANOW, &tty) != 0) {
        perror("??????????????");
        return false;
    }
    return true;
}

// ??????????????/dev/ttyS4??
bool initSerial() {
    const char* port = "/dev/ttyS4";
    serialFd = open(port, O_RDWR | O_NOCTTY | O_SYNC);
    if (serialFd < 0) {
        perror("???????????????sudo???§µ?");
        return false;
    }
    if (!configureSerial(serialFd)) {
        close(serialFd);
        serialFd = -1;
        return false;
    }
    cout << "????" << port << "????????" << endl;
    return true;
}

// ?????????????????????????????????
void readHumiture() {
    if (serialFd < 0) return;

    // ???????????0x01???????0x0000????2????????????+????
    unsigned char sendBuf[] = { 0x01, 0x03, 0x00, 0x00, 0x00, 0x02, 0xC4, 0x0B };
    write(serialFd, sendBuf, sizeof(sendBuf));
    cout << "?????????01 03 00 00 00 02 C4 0B" << endl;

    // ????????????
    unsigned char recvBuf[256] = { 0 };
    ssize_t len = read(serialFd, recvBuf, sizeof(recvBuf));

    // ?????????????????????/?????????
    cout << "??????????????????" << len << "??????";
    for (ssize_t i = 0; i < len; ++i) {
        printf("%02X ", recvBuf[i]);
    }
    cout << endl;

    // ???????9????????MODBUS RTU§¿?ï‚
    if (len == 9 && recvBuf[0] == 0x01 && recvBuf[1] == 0x03) {
        // ???????????????????????????
        uint16_t humiData = (recvBuf[3] << 8) | recvBuf[4];
        uint16_t tempData = (recvBuf[5] << 8) | recvBuf[6];
        float temperature = tempData / 10.0;
        float humidity = humiData / 10.0;

        cout << "?????????" << endl;
        cout << "????" << fixed << setprecision(1) << temperature << "?? "
            << "????" << fixed << setprecision(1) << humidity << "%RH" << endl;
    }
    else if (len == 0) {
        cout << "¦Ä??????????????????????????" << endl;
    }
    else {
        cout << "??????????/????????????????" << endl;
    }
    cout << "----------------------------------------" << endl;
}

// ??????
void closeSerial() {
    if (serialFd >= 0) {
        close(serialFd);
        cout << "????????" << endl;
    }
}

int main() {
    if (!initSerial()) return 1;

    cout << "???????????????Ctrl+C????" << endl;
    cout << "----------------------------------------" << endl;

    while (true) {
        readHumiture();
        this_thread::sleep_for(chrono::seconds(1));  // 1???????
    }

    closeSerial();
    return 0;
}